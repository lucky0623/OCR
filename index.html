<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow, noarchive">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 3 å…¨èƒ½ AI å°å¸« (å”ä½œå¢å¼·ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      options: { ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #8e44ad;
            --bg: #fdfbf7;
            --surface: #ffffff;
            --border: #dcdcdc;
            --sidebar-width: 350px;
        }

        body {
            font-family: 'Noto Serif TC', 'Songti TC', serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden; /* é˜²æ­¢é›™é‡æ²è»¸ */
        }

        /* --- ä¸»å…§å®¹å€ --- */
        .main-wrapper {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            transition: margin-right 0.3s ease;
            position: relative;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--surface);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            border: 1px solid #e0e0e0;
        }

        h1 { margin: 0 0 10px 0; font-weight: 700; letter-spacing: 2px; font-size: 2em; text-align: center; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 25px; font-family: sans-serif; }

        /* --- 1. æ¥µç°¡åŒ–ä¸Šå‚³å€ --- */
        .toolbar-top {
            display: flex; gap: 15px; align-items: center; margin-bottom: 20px;
            background: #f8f9fa; padding: 10px 20px; border-radius: 6px; border: 1px solid #eee;
        }
        
        .upload-btn-mini {
            display: flex; align-items: center; gap: 8px;
            background: #fff; border: 1px solid #ccc; padding: 8px 15px;
            border-radius: 4px; cursor: pointer; font-weight: bold; font-family: sans-serif;
            transition: all 0.2s;
        }
        .upload-btn-mini:hover { border-color: var(--accent); color: var(--accent); }

        .settings-row { display: flex; gap: 15px; flex: 1; }
        select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-weight: 700; flex: 1; }
        
        /* --- 2. ç¬¬äºŒæŒ‡ä»¤æ¬„ä½ --- */
        .instruction-box {
            margin: 20px 0;
            border: 2px solid var(--accent);
            border-radius: 6px;
            background: #fff;
            padding: 15px;
            position: relative;
        }
        .instruction-label {
            position: absolute; top: -12px; left: 15px;
            background: var(--accent); color: white;
            padding: 2px 10px; font-size: 0.85em; border-radius: 4px;
            font-weight: bold; font-family: sans-serif;
        }
        .instruction-input {
            width: 100%; border: none; outline: none;
            font-size: 1.1em; font-family: sans-serif; resize: none;
            min-height: 40px; color: #333;
        }
        
        /* é è¦½èˆ‡ç‹€æ…‹ */
        #preview-box { display: none; margin: 10px 0; text-align: center; }
        #preview-img { max-height: 120px; border-radius: 4px; border: 1px solid #eee; }
        .status-text { text-align: center; font-weight: bold; color: #666; margin: 10px 0; min-height: 20px; font-family: sans-serif; }

        /* é›™æ¬„å€ */
        .split-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 600px; }
        .panel { 
            border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; 
            background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .panel-header {
            padding: 10px 15px; background: #fcfcfc; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; font-family: sans-serif;
        }
        .panel-title { font-weight: bold; font-size: 1em; color: #444; }
        .editor {
            flex: 1; padding: 25px; overflow-y: auto; outline: none;
            font-size: 19px; line-height: 1.8; color: #2c3e50;
        }

        /* è¦–è¦ºæ¨£å¼ */
        .editor h3 { color: var(--accent); font-size: 1.2em; border-bottom: 1px solid #eee; margin-top: 25px; font-weight: 700; }
        .editor h3::before { content: 'âœ¦ '; }
        .editor blockquote { border-left: 4px solid var(--accent); background: #f9f9f9; padding: 15px; margin: 15px 0; font-style: normal; }
        .editor strong { color: #c0392b; font-weight: 700; }

        /* æŒ‰éˆ• */
        .btn-big {
            width: 100%; padding: 12px; background: var(--accent); color: white; border: none;
            border-radius: 4px; font-size: 1.1em; font-weight: bold; cursor: pointer;
            margin-top: 10px; font-family: sans-serif;
        }
        .btn-big:hover { opacity: 0.9; }

        /* --- 3. AI å´é‚Šæ¬„ (Sidebar) --- */
        .sidebar {
            position: fixed; top: 0; right: -360px; /* é è¨­éš±è— */
            width: var(--sidebar-width); height: 100%;
            background: #fff; border-left: 1px solid #ddd;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
            transition: right 0.3s ease;
            z-index: 1000;
        }
        .sidebar.open { right: 0; }
        
        .sidebar-header {
            padding: 15px; background: var(--accent); color: white; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center; font-family: sans-serif;
        }
        .chat-area {
            flex: 1; padding: 15px; overflow-y: auto; background: #f4f6f7;
            display: flex; flex-direction: column; gap: 10px;
        }
        .chat-input-area {
            padding: 15px; border-top: 1px solid #eee; background: #fff; display: flex; gap: 10px;
        }
        .chat-input {
            flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; outline: none; font-family: sans-serif;
        }
        .chat-send-btn {
            background: var(--accent); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer;
        }

        /* èŠå¤©æ°£æ³¡ */
        .msg { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 0.95em; line-height: 1.5; font-family: sans-serif; }
        .msg-ai { align-self: flex-start; background: #fff; border: 1px solid #e0e0e0; color: #333; }
        .msg-user { align-self: flex-end; background: var(--accent); color: white; }
        
        /* å´é‚Šæ¬„é–‹é—œæŒ‰éˆ• */
        .sidebar-toggle {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--accent); color: white;
            display: flex; justify-content: center; align-items: center;
            font-size: 30px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1001; transition: transform 0.2s;
        }
        .sidebar-toggle:hover { transform: scale(1.1); }

    </style>
</head>
<body>

<div class="main-wrapper" id="main-wrapper">
    <div class="container">
        <h1>Gemini 3 å…¨èƒ½ AI å°å¸«</h1>
        <div class="subtitle">å”ä½œæ¨¡å¼ï¼šä¸Šå‚³ â” æŒ‡ä»¤å¾®èª¿ â” å°ˆå®¶è§£æ â” åŠ©æ‰‹è¨è«–</div>

        <div class="toolbar-top">
            <label class="upload-btn-mini">
                <span>ğŸ“ ä¸Šå‚³åœ–ç‰‡</span>
                <input type="file" id="file-input" accept="image/*" style="display:none">
            </label>
            
            <div class="settings-row">
                <select id="role-select" onchange="updateRoleUI()">
                    <option value="translator">ğŸ“ ç­†è­¯å°ˆå®¶</option>
                    <option value="interpreter">ğŸ—£ï¸ å£è­¯å°ˆå®¶</option>
                    <option value="math">ğŸ“ æ•¸å­¸å®¶æ•™</option>
                    <option value="toefl">ğŸ“ TOEFL è€å¸«</option>
                    <option value="psych">ğŸ§  å¿ƒç†å­¸æ•™æˆ</option>
                    <option value="coder">ğŸ’» ç¨‹å¼å°å¸«</option>
                </select>
                <select id="target-lang">
                    <option value="Traditional Chinese (Taiwan)">ç¹é«”ä¸­æ–‡ (å°ç£)</option>
                    <option value="English">English</option>
                    <option value="Japanese">Japanese</option>
                </select>
            </div>
        </div>

        <div id="preview-box"><img id="preview-img"></div>

        <div class="instruction-box">
            <div class="instruction-label">âœ¨ ç¬¬äºŒæŒ‡ä»¤ (å°å°ˆå®¶çš„é¡å¤–è¦æ±‚)</div>
            <textarea id="user-instruction" class="instruction-input" placeholder="ä¾‹å¦‚ï¼šè«‹ç”¨æ›´å¹½é»˜çš„èªæ°£ã€è«‹æŠŠé€™æ®µç¿»è­¯æˆå°èªã€è«‹è§£é‡‹é€™å…¬å¼çš„æ­·å²èƒŒæ™¯..." rows="1"></textarea>
        </div>

        <button id="btn-run" class="btn-big" onclick="startAIAnalysis()">é–‹å§‹å°ˆå®¶åˆ†æ</button>
        <div id="status-text" class="status-text"></div>

        <div class="split-container">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">åŸå§‹å…§å®¹</span>
                    <button onclick="document.getElementById('input-editor').focus()" style="border:none;background:none;cursor:pointer;">âœ</button>
                </div>
                <div id="input-editor" class="editor tex2jax_process" contenteditable="true"></div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title" id="expert-title">å°ˆå®¶è¼¸å‡º</span>
                    <button onclick="copyContent('output-editor')" style="border:none;background:none;cursor:pointer;">ğŸ“‹</button>
                </div>
                <div id="output-editor" class="editor tex2jax_process" contenteditable="true"></div>
            </div>
        </div>
    </div>
</div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span>ğŸ¤– AI å”ä½œåŠ©æ‰‹</span>
        <span onclick="toggleSidebar()" style="cursor:pointer;">âœ•</span>
    </div>
    <div class="chat-area" id="chat-area">
        <div class="msg msg-ai">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å”ä½œåŠ©æ‰‹ã€‚æˆ‘å·²ç¶“è®€éå·¦é‚Šçš„å…§å®¹å’Œå³é‚Šçš„å°ˆå®¶å›ç­”äº†ã€‚æœ‰ä»€éº¼æƒ³è¨è«–çš„å—ï¼Ÿ</div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chat-input" class="chat-input" placeholder="å•å•å°åŠ©æ‰‹..." onkeypress="if(event.key==='Enter') sendChat()">
        <button class="chat-send-btn" onclick="sendChat()">â¤</button>
    </div>
</div>

<div class="sidebar-toggle" onclick="toggleSidebar()">ğŸ’¬</div>

<script>
    // ==========================================
    const MY_API_KEY = "AIzaSyARnOyCalravUFD_FuZoVtZAFOmG5hLLSQ"; 
    // ==========================================

    // --- è§’è‰²å®šç¾© (æ”¯æ´ç¬¬äºŒæŒ‡ä»¤) ---
    const ROLES = {
        translator: {
            title: "ç­†è­¯å°ˆå®¶", color: "#27ae60",
            prompt: (content, lang, instruction) => `
                ä½ æ˜¯ä¸€ä½è³‡æ·±ç­†è­¯ã€‚æ¯èªï¼š${lang}ã€‚
                ä¾†æºå…§å®¹: "${content}"
                
                **ä½¿ç”¨è€…é¡å¤–æŒ‡ä»¤**: "${instruction || 'ç„¡'}" (è«‹å‹™å¿…å„ªå…ˆéµå®ˆæ­¤æŒ‡ä»¤)

                è«‹ä»¥ Markdown å›æ‡‰ï¼š
                ### å°ˆå®¶è¦–è§’
                > (åˆ†æåŸæ–‡èˆ‡ä½¿ç”¨è€…æŒ‡ä»¤ï¼Œèªªæ˜ç­–ç•¥)
                ### è­¯æ–‡ç”¢å‡º
                (é«˜å“è³ªç¿»è­¯)
                ### è­¯è¨»
            `
        },
        interpreter: {
            title: "å£è­¯å°ˆå®¶", color: "#16a085",
            prompt: (content, lang, instruction) => `
                ä½ æ˜¯ä¸€ä½åŒæ­¥å£è­¯å“¡ã€‚æ¯èªï¼š${lang}ã€‚
                ä¾†æº: "${content}"
                **ä½¿ç”¨è€…æŒ‡ä»¤**: "${instruction || 'ç„¡'}"
                
                è«‹ä»¥ Markdown å›æ‡‰ï¼š
                ### å£è­¯ç­†è¨˜
                > (åˆ†æèªæ°£ã€é€Ÿåº¦èˆ‡ç­–ç•¥)
                ### å£èªè¼¸å‡º
                (æ¨¡æ“¬ç¾å ´å£è­¯)
            `
        },
        math: {
            title: "æ•¸å­¸å®¶æ•™", color: "#e67e22",
            prompt: (content, lang, instruction) => `
                Math Tutor (${lang}). Problem: "${content}"
                **User Instruction**: "${instruction || 'None'}"
                
                Markdown Response:
                ### Insight
                > (Geeky analysis)
                ### Solution
                (LaTeX steps)
            `
        },
        toefl: { title: "TOEFL è€å¸«", color: "#c0392b", prompt: (c, l, i) => `TOEFL Expert (${l}). Input: "${c}". **Instruction**: "${i}". Provide critique and rewrite.` },
        psych: { title: "å¿ƒç†å­¸æ•™æˆ", color: "#8e44ad", prompt: (c, l, i) => `Psychology Prof (${l}). Input: "${c}". **Instruction**: "${i}". Analyze deeply.` },
        coder: { title: "ç¨‹å¼å°å¸«", color: "#2980b9", prompt: (c, l, i) => `Senior Dev (${l}). Input: "${c}". **Instruction**: "${i}". Review and fix.` }
    };

    // DOM Elements
    const roleSelect = document.getElementById('role-select');
    const inputEditor = document.getElementById('input-editor');
    const outputEditor = document.getElementById('output-editor');
    const userInstruction = document.getElementById('user-instruction');
    const statusText = document.getElementById('status-text');
    const btnRun = document.getElementById('btn-run');
    const fileInput = document.getElementById('file-input');
    const previewBox = document.getElementById('preview-box');
    const previewImg = document.getElementById('preview-img');
    const sidebar = document.getElementById('sidebar');
    const chatArea = document.getElementById('chat-area');
    const chatInput = document.getElementById('chat-input');

    let currentFileBase64 = null;
    let currentFileType = null;

    // --- UI Logic ---
    function updateRoleUI() {
        const role = ROLES[roleSelect.value];
        document.documentElement.style.setProperty('--accent', role.color);
        document.getElementById('expert-title').innerText = role.title + " è¼¸å‡º";
    }

    function toggleSidebar() {
        sidebar.classList.toggle('open');
        const main = document.getElementById('main-wrapper');
        main.style.marginRight = sidebar.classList.contains('open') ? '350px' : '0';
    }

    // --- File Handling ---
    fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
    document.addEventListener('paste', e => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) { if (item.kind === 'file') handleFile(item.getAsFile()); }
    });

    function handleFile(file) {
        if(!file) return;
        previewImg.src = URL.createObjectURL(file);
        previewBox.style.display = 'block';
        statusText.innerText = "è®€å–ä¸­...";
        
        const reader = new FileReader();
        reader.onloadend = () => {
            currentFileBase64 = reader.result.split(',')[1];
            currentFileType = file.type;
            runVision();
        };
        reader.readAsDataURL(file);
    }

    // --- AI Flow ---
    
    // 1. Vision (OCR)
    async function runVision() {
        try {
            const text = await callGeminiAPI(
                `gemini-3-flash-preview`, 
                [{text: "Transcribe text/math exactly. Use LaTeX for math."}, {inline_data: {mime_type: currentFileType, data: currentFileBase64}}]
            );
            inputEditor.innerHTML = marked.parse(text);
            statusText.innerText = "è®€å–å®Œæˆï¼Œè«‹è¼¸å…¥æŒ‡ä»¤æˆ–ç›´æ¥é–‹å§‹åˆ†æ";
            if(window.MathJax) MathJax.typesetPromise([inputEditor]);
        } catch(e) { console.error(e); statusText.innerText = "è®€å–å¤±æ•—"; }
    }

    // 2. Expert Analysis (with User Instruction)
    async function startAIAnalysis() {
        const content = inputEditor.innerText;
        const instruction = userInstruction.value;
        const role = ROLES[roleSelect.value];
        const lang = document.getElementById('target-lang').value;

        if(!content) return alert("è«‹å…ˆä¸Šå‚³å…§å®¹");

        btnRun.disabled = true;
        outputEditor.innerHTML = "(å°ˆå®¶æ€è€ƒä¸­...)";
        statusText.innerText = `${role.title} æ­£åœ¨è™•ç†æ‚¨çš„æŒ‡ä»¤...`;

        try {
            const prompt = role.prompt(content, lang, instruction);
            const res = await callGeminiAPI(`gemini-3-pro-preview`, [{text: prompt}]);
            outputEditor.innerHTML = marked.parse(res);
            statusText.innerText = "åˆ†æå®Œæˆ";
            if(window.MathJax) MathJax.typesetPromise([outputEditor]);
            
            // è‡ªå‹•æ‰“é–‹å´é‚Šæ¬„ï¼Œé‚€è«‹è¨è«–
            if(!sidebar.classList.contains('open')) toggleSidebar();
            
        } catch(e) { console.error(e); outputEditor.innerText = "éŒ¯èª¤: " + e.message; }
        finally { btnRun.disabled = false; }
    }

    // 3. Chat Assistant (Sidekick)
    async function sendChat() {
        const msg = chatInput.value;
        if(!msg) return;
        
        // Add User Msg
        addChatMsg(msg, 'user');
        chatInput.value = '';

        // Context Construction
        const context = `
            Context:
            [Source Content]: ${inputEditor.innerText.substring(0, 500)}...
            [Expert Output]: ${outputEditor.innerText.substring(0, 500)}...
            
            User Question: "${msg}"
            
            You are a helpful AI Assistant sitting next to the user. 
            Discuss the expert's output or the source content. Be concise and helpful.
        `;

        try {
            // Use Flash for fast chat
            const res = await callGeminiAPI(`gemini-3-flash-preview`, [{text: context}]);
            addChatMsg(res, 'ai');
        } catch(e) { addChatMsg("ç„¡æ³•é€£ç·š...", 'ai'); }
    }

    function addChatMsg(text, type) {
        const div = document.createElement('div');
        div.className = `msg msg-${type}`;
        div.innerHTML = marked.parse(text); // Support markdown in chat
        chatArea.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    // --- Generic API Caller ---
    async function callGeminiAPI(model, parts) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${MY_API_KEY}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ contents: [{ parts: parts }] })
        });
        const data = await response.json();
        if(data.error) throw new Error(data.error.message);
        return data.candidates[0].content.parts[0].text;
    }

    function copyContent(id) { navigator.clipboard.writeText(document.getElementById(id).innerText); }
    updateRoleUI();
</script>
</body>
</html>